# キャラクターフィルタ機能実装メモ

## 実装内容

### 1. ネタバレフィルタ（優先処理）
- `spoiler-filter`セレクトボックスで巻数を選択
- 選択した巻数以下のキャラクターのみ表示対象となる
- 巻数を変更すると、キャラクターフィルタのリストも自動更新される

### 2. キャラクターフィルタ（個別ON/OFF）
- 各キャラクターをクリックしてON/OFFを切り替え
- ONになっているキャラクターのみマーカーが表示される
- 「全て選択」「全て解除」ボタンで一括操作可能

### 3. フィルタの優先順位
```
最終的な表示 = ネタバレフィルタ(巻数チェック) AND キャラクターフィルタ(ON/OFF)
```

つまり、以下の両方の条件を満たすキャラクターのみが地図上に表示されます：
1. 現在の巻数設定以下で登場するキャラクター
2. キャラクターフィルタでONになっているキャラクター

## 実装ファイル

### js/characterFilter.js
- `initCharacterFilter()`: フィルタUIを初期化
- `handleCharacterToggle()`: 個別キャラクターのON/OFF処理
- `updateCharacterMarkerVisibility()`: マーカーの表示/非表示を更新
- `updateCharacterFilterLanguage()`: 言語切り替え時の表示更新

### js/ui.js
- `applySpoilerFilter()`: ネタバレフィルタの適用
- `initLanguageToggle()`: 言語切り替え時にマーカーとフィルタの言語を更新

### js/characterMarkers.js
- `addCharacterMarkers()`: マーカー作成時に初期表示状態を設定
- `updateCharacterPositions()`: 時刻更新時にフィルタを適用
- `updateOverlapLayout()`: 表示されているマーカーのみ重なり解消を適用
- `updateMarkerLanguage()`: マーカーのアイコンテキストを更新

### js/config.js
- `AppState.enabledCharacters`: 有効なキャラクターIDのSet
- `AppState.currentVolume`: 現在の既読巻数

## 使用方法

1. **ネタバレフィルタで巻数を選択**
   - 例: 「イクサガミ天（1巻読了）」を選択すると、1巻のキャラクターのみがフィルタに表示される

2. **個別キャラクターのON/OFF**
   - フィルタリストのキャラクターをクリック
   - activeクラスが付いているものが表示される

3. **一括操作**
   - 「全て選択」: 現在の巻数内の全キャラクターを表示
   - 「全て解除」: 全キャラクターを非表示

4. **言語切り替え**
   - 日本語/Englishボタンで切り替え
   - マーカーとフィルタの表示が連動して変更される

## 動作確認ポイント

- [ ] ネタバレフィルタを変更すると、キャラクターフィルタのリストが更新される
- [ ] キャラクターをクリックすると、地図上のマーカーが即座に表示/非表示される
- [ ] 「全て選択」「全て解除」ボタンが正しく機能する
- [ ] 時系列スライダーを動かしてもフィルタ設定が維持される
- [ ] 言語を切り替えると、マーカーとフィルタの両方が更新される
- [ ] 重なっているマーカーでもフィルタが正しく動作する
- [ ] 巻数を変更してから特定のキャラクターをOFFにしても、再度ONにできる
- [ ] トラッキングカードの開閉時にマーカーが消えない
- [ ] 枝分かれ（SVG）マーカーもフィルタで正しく表示/非表示される

## トラブルシューティング

### 枝分かれマーカーの表示不安定問題の修正

**問題**: フィルタ更新時やトラッキングON/OFF時に、重なって枝分かれしているマーカーが一時的に非表示になる

**原因**:
1. `updateOverlapLayout()`がHTMLマーカーとSVGマーカーを切り替える際、フィルタ状態を考慮していなかった
2. HTMLマーカーの`display`を無条件に`none`にしていた
3. SVGマーカー作成時に初期表示状態を設定していなかった

**修正内容**:
1. `updateOrCreateSvgMarker()`: SVGマーカー作成/更新時にフィルタ状態をチェック
2. `createSvgMarker()`: 初期表示状態を引数で受け取る
3. `updateOverlapLayout()`: 単独マーカー表示時にフィルタ状態を確認
4. `updateCharacterMarkerVisibility()`: HTMLとSVG両方のマーカーの表示状態を更新
5. 髭線描画: 非表示マーカーの髭線を描画しないように修正

### 地図移動・拡大縮小時の表示問題の修正

**問題**: 地図を移動や拡大縮小すると、フィルタで非表示にしたキャラクターが表示されてしまう

**原因**:
- `updateOverlapLayout()`で`positions`を作成する際、HTMLマーカーの`display`プロパティのみをチェックしていた
- 地図イベント時にフィルタ状態を再確認していなかった

**修正内容**:
1. `updateOverlapLayout()`の冒頭で、フィルタ状態（巻数＋ON/OFF）を明示的にチェック
2. フィルタで表示状態のマーカーのみを`positions`に含める
3. `positions`に含まれているマーカーは必ず表示状態なので、後続処理を簡略化
4. デバッグログ追加: 表示マーカー数とグループ数を出力

### マーカーホバー時のZ-index問題の修正

**問題**: 重なっているマーカーをマウスホバーしても最前面に表示されない

**原因**:
1. HTMLマーカー: 要素自体の`z-index`を変更していたが、MapLibre GLのマーカーコンテナ（`.maplibregl-marker`）の`z-index`を変更する必要がある
2. SVGマーカー: SVGでは`z-index`が効かないため、DOM要素の順序を変更する必要がある

**修正内容**:

1. **HTMLマーカー（単独表示時）**
   - ホバー時に親要素（`.maplibregl-marker`）を探してその`z-index`を`1000`に設定
   - `while`ループで確実に親要素を取得
   - ホバー解除時に`z-index`を元に戻す

2. **SVGマーカー（重なり解消時）**
   - ホバー時に`group.parentNode.appendChild(group)`で要素を親の最後に移動
   - SVGでは後に描画された要素が前面に表示される仕様を利用
   
3. **デバッグログ追加**
   - ホバー時にコンソールに`[CharacterMarkers] HTML/SVG Marker hover`を出力

**テスト方法**:
- 重なっているマーカーにマウスを乗せる
- ホバーしたマーカーが他のマーカーの上に表示される
- コンソールにホバーログが表示される

### トラッキング中キャラクターの自動解除機能

**機能**: トラッキング中のキャラクターがフィルタで非表示になった際、自動的にトラッキングをOFFにする

**実装内容**:

1. **フィルタ更新時のチェック**
   - `updateCharacterMarkerVisibility()`でトラッキング中のキャラクターIDを取得
   - そのキャラクターが非表示になるかチェック
   - 非表示になる場合は`hideTrackingCard()`を呼び出してトラッキングを解除

2. **トラッキング状態の共有**
   - `characterTracking.js`で`getCurrentTrackingCharacterId()`関数をエクスポート
   - `characterFilter.js`からこの関数を使ってトラッキング状態を確認

3. **ログ出力**
   - トラッキング解除時にコンソールに`Tracking character X is now hidden, disabling tracking`を出力

**テスト方法**:

1. **キャラクターフィルタでの解除**
   - マーカーをクリックしてトラッキングカードを表示
   - フィルタでそのキャラクターをOFFにする
   - トラッキングカードが自動的に閉じることを確認
   - コンソールにトラッキング解除のログが表示される

2. **ネタバレフィルタでの解除**
   - 例: 2巻のキャラクター（蹴上甚六など）をトラッキング
   - ネタバレフィルタを「1巻読了」に変更
   - トラッキングカードが自動的に閉じることを確認

3. **全て解除ボタン**
   - キャラクターをトラッキング中
   - 「全て解除」ボタンをクリック
   - トラッキングカードが自動的に閉じることを確認

4. **地図移動後も動作**
   - トラッキング中のキャラクターをOFF
   - 地図を移動・拡大縮小
   - トラッキングは解除されたまま維持される
